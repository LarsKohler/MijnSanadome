<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mijn Profiel · MijnSanadome</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --sanadome-blue: #3b82c4;
      --sanadome-blue-light: #60a5e8;
      --sanadome-blue-pale: #eff6ff;
      --sanadome-blue-mist: #f0f7ff;
      --sanadome-text: #0f172a;
      --sanadome-text-soft: #64748b;
      --sanadome-border: #e2e8f0;
      --white: #ffffff;
      --radius: 16px;
      --radius-sm: 10px;
      --sidebar-w: 270px;
      --topbar-h: 68px;
      --shadow-card: 0 1px 2px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.04);
      --shadow-card-hover: 0 8px 30px rgba(59,130,196,0.10), 0 2px 8px rgba(0,0,0,0.04);
      --shadow-elevated: 0 12px 40px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
      --gradient-primary: linear-gradient(135deg, #3b82c4 0%, #60a5e8 100%);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      min-height: 100vh;
      background: #f1f5f9;
      color: var(--sanadome-text);
      font-size: 15px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      opacity: 0; transition: opacity .18s ease;
    }
    body.app-ready { opacity: 1; }
    .app-loader { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: #f1f5f9; }
    .app-loader .spinner { width: 36px; height: 36px; border: 3px solid var(--sanadome-border); border-top-color: var(--sanadome-blue); border-radius: 50%; animation: spin .6s linear infinite; }
    body.app-ready .app-loader { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .app-layout { display: flex; min-height: 100vh; }

    /* —— Sidebar —— */
    .app-sidebar {
      width: var(--sidebar-w); min-width: var(--sidebar-w);
      background: var(--white); border-right: 1px solid var(--sanadome-border);
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
    }
    .sidebar-logo {
      display: flex; align-items: center; gap: 0.7rem;
      padding: 1.25rem 1.5rem; text-decoration: none; color: var(--sanadome-text);
      border-bottom: 1px solid var(--sanadome-border);
    }
    .sidebar-logo svg { width: 36px; height: 36px; flex-shrink: 0; }
    .sidebar-logo-text {
      font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700;
      font-size: 1.2rem; letter-spacing: -0.02em; color: var(--sanadome-text);
    }
    .sidebar-logo-text span { color: var(--sanadome-blue); }
    .sidebar-nav { flex: 1; padding: 1rem 0.75rem; overflow-y: auto; }
    .nav-label {
      font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--sanadome-text-soft);
      padding: 0 0.75rem; margin-bottom: 0.5rem; margin-top: 0.75rem;
    }
    .nav-item {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.6rem 0.75rem; border-radius: var(--radius-sm);
      color: var(--sanadome-text-soft); text-decoration: none;
      font-weight: 500; font-size: 0.9rem; margin-bottom: 2px;
      transition: all 0.15s ease; position: relative;
    }
    .nav-item:hover { background: var(--sanadome-blue-mist); color: var(--sanadome-text); }
    .nav-item.active { background: var(--sanadome-blue-pale); color: var(--sanadome-blue); }
    .nav-item.active::before {
      content: ''; position: absolute; left: -0.75rem; top: 50%;
      transform: translateY(-50%); width: 3px; height: 24px;
      border-radius: 0 3px 3px 0; background: var(--sanadome-blue);
    }
    .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; }

    /* —— Main area —— */
    .app-main { flex: 1; margin-left: var(--sidebar-w); display: flex; flex-direction: column; min-height: 100vh; }

    /* Top bar */
    .topbar {
      height: var(--topbar-h);
      background: rgba(255,255,255,0.85); backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(226,232,240,0.6);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 2rem; gap: 1rem; position: sticky; top: 0; z-index: 50;
    }
    .topbar-title {
      font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700;
      font-size: 1rem; color: var(--sanadome-text);
    }
    .topbar-actions { display: flex; align-items: center; gap: 0.5rem; }
    .topbar-icon-btn {
      width: 40px; height: 40px; border: none; background: transparent;
      border-radius: var(--radius-sm); color: var(--sanadome-text-soft);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.15s ease; position: relative;
    }
    .topbar-icon-btn:hover { background: var(--sanadome-blue-mist); color: var(--sanadome-blue); }
    .topbar-icon-btn svg { width: 20px; height: 20px; }
    .topbar-user {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.35rem 0.5rem 0.35rem 0.75rem; border-radius: var(--radius-sm);
      margin-left: 0.5rem; border: 1px solid transparent; transition: background 0.15s;
      text-decoration: none; color: inherit; cursor: pointer;
    }
    .topbar-user:hover { background: var(--sanadome-blue-mist); }
    .topbar-avatar {
      width: 38px; height: 38px; border-radius: 50%;
      background: var(--gradient-primary); color: var(--white);
      font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600; font-size: 0.85rem;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(59,130,196,0.25);
    }
    .topbar-user-info { text-align: left; }
    .topbar-user-name { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600; font-size: 0.9rem; color: var(--sanadome-text); display: block; line-height: 1.3; }
    .topbar-user-role { font-size: 0.75rem; color: var(--sanadome-text-soft); display: block; }
    .btn-logout {
      padding: 0.45rem 0.85rem; font-size: 0.8rem; font-family: inherit; font-weight: 600;
      color: var(--white); background: var(--gradient-primary); border: none;
      border-radius: var(--radius-sm); cursor: pointer; margin-left: 0.5rem;
      transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(59,130,196,0.2);
    }
    .btn-logout:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,196,0.3); }

    /* —— Profile page content —— */
    .profile-content {
      flex: 1;
      padding: 2rem;
      width: 100%;
      min-height: calc(100vh - var(--topbar-h));
      display: flex;
      flex-direction: column;
    }
    .profile-inner {
      width: 100%;
      max-width: 100%;
      flex: 1;
    }

    .profile-header {
      display: flex; align-items: center; gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .profile-header-avatar {
      position: relative;
      width: 96px; height: 96px; flex-shrink: 0;
    }
    .profile-header-avatar-img {
      width: 96px; height: 96px; border-radius: 50%;
      background: var(--gradient-primary); color: var(--white);
      font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700; font-size: 2rem;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 20px rgba(59,130,196,0.25);
      object-fit: cover;
      overflow: hidden;
    }
    .profile-header-avatar-img img {
      width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
    }
    .profile-photo-edit {
      position: absolute; bottom: 0; right: 0;
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--white); border: 2px solid var(--sanadome-border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .profile-photo-edit:hover {
      background: var(--sanadome-blue-pale); border-color: var(--sanadome-blue);
    }
    .profile-photo-edit svg { width: 14px; height: 14px; color: var(--sanadome-text-soft); }
    .profile-photo-edit:hover svg { color: var(--sanadome-blue); }
    .profile-header-info h1 {
      font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700;
      font-size: 1.5rem; color: var(--sanadome-text); letter-spacing: -0.02em;
    }
    .profile-header-info p {
      font-size: 0.875rem; color: var(--sanadome-text-soft); margin-top: 0.2rem;
    }

    /* Tabs */
    .profile-tabs {
      display: flex; gap: 0; border-bottom: 2px solid var(--sanadome-border);
      margin-bottom: 1.5rem;
    }
    .profile-tab {
      padding: 0.65rem 1.25rem; font-size: 0.875rem; font-weight: 600;
      color: var(--sanadome-text-soft); background: none; border: none;
      cursor: pointer; position: relative; transition: color 0.2s;
      font-family: inherit; white-space: nowrap;
    }
    .profile-tab:hover { color: var(--sanadome-text); }
    .profile-tab.active {
      color: var(--sanadome-blue);
    }
    .profile-tab.active::after {
      content: ''; position: absolute; bottom: -2px; left: 0; right: 0;
      height: 2px; background: var(--sanadome-blue); border-radius: 2px 2px 0 0;
    }

    /* Tab panels */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Cards */
    .profile-card {
      background: var(--white); border-radius: var(--radius);
      border: 1px solid rgba(226,232,240,0.7); box-shadow: var(--shadow-card);
      padding: 1.75rem 2rem; margin-bottom: 1.25rem;
      width: 100%;
    }
    .profile-card-title {
      font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700;
      font-size: 0.95rem; color: var(--sanadome-text); margin-bottom: 1.25rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .profile-card-title svg {
      width: 18px; height: 18px; color: var(--sanadome-blue); flex-shrink: 0;
    }

    /* Form elements */
    .form-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;
      margin-bottom: 1.15rem; width: 100%;
    }
    .form-row.triple { grid-template-columns: 1fr 1fr 1fr; }
    .form-row.single { grid-template-columns: 1fr; }
    @media (max-width: 900px) {
      .form-row.triple { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px) {
      .form-row, .form-row.triple { grid-template-columns: 1fr; }
      .profile-content { padding: 1.25rem; }
      .profile-card { padding: 1.25rem; }
      .profile-header { flex-direction: column; text-align: center; gap: 1rem; }
      .profile-header-avatar { margin: 0 auto; }
      .profile-tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }
    @media (max-width: 480px) {
      .profile-content { padding: 0.75rem; }
      .profile-card { padding: 1rem 0.85rem; }
      .btn-group { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }
    .form-group { display: flex; flex-direction: column; min-width: 0; }
    .form-label {
      font-size: 0.78rem; font-weight: 600; color: var(--sanadome-text-soft);
      margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.04em;
    }
    .form-input {
      padding: 0.6rem 0.85rem; font-family: inherit; font-size: 0.875rem;
      color: var(--sanadome-text); background: #f8fafc;
      border: 1.5px solid var(--sanadome-border); border-radius: var(--radius-sm);
      outline: none; transition: all 0.2s ease; width: 100%;
    }
    .form-input:focus {
      background: var(--white); border-color: var(--sanadome-blue);
      box-shadow: 0 0 0 3px rgba(59,130,196,0.1);
    }
    .form-input:disabled {
      background: #f1f5f9; color: var(--sanadome-text-soft); cursor: not-allowed;
    }
    textarea.form-input { resize: vertical; min-height: 80px; }
    select.form-input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2rem;
    }

    /* Password strength */
    .password-strength { margin-top: 0.5rem; }
    .password-bar {
      height: 4px; border-radius: 2px; background: var(--sanadome-border);
      overflow: hidden; margin-bottom: 0.35rem;
    }
    .password-bar-fill {
      height: 100%; border-radius: 2px; transition: width 0.3s, background 0.3s;
      width: 0;
    }
    .password-strength-text {
      font-size: 0.72rem; color: var(--sanadome-text-soft);
    }

    /* Buttons */
    .btn-group { display: flex; gap: 0.75rem; margin-top: 1.25rem; }
    .btn {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.55rem 1.2rem; font-size: 0.85rem; font-weight: 600;
      font-family: inherit; border-radius: var(--radius-sm);
      cursor: pointer; transition: all 0.2s ease; border: none;
    }
    .btn svg { width: 16px; height: 16px; flex-shrink: 0; }
    .btn-primary {
      color: var(--white); background: var(--gradient-primary);
      box-shadow: 0 2px 8px rgba(59,130,196,0.25);
    }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(59,130,196,0.3); }
    .btn-secondary {
      color: var(--sanadome-text); background: var(--white);
      border: 1.5px solid var(--sanadome-border);
    }
    .btn-secondary:hover { border-color: var(--sanadome-blue); color: var(--sanadome-blue); }
    .btn-danger {
      color: #dc2626; background: #fef2f2; border: 1.5px solid #fecaca;
    }
    .btn-danger:hover { background: #fee2e2; border-color: #f87171; }

    /* Toast notification */
    .toast {
      position: fixed; bottom: 2rem; right: 2rem; z-index: 9999;
      padding: 0.85rem 1.25rem; border-radius: var(--radius-sm);
      font-size: 0.85rem; font-weight: 600; color: var(--white);
      background: #16a34a; box-shadow: var(--shadow-elevated);
      transform: translateY(120%); opacity: 0;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { background: #dc2626; }

    /* Photo upload modal */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(15,23,42,0.5); backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius);
      box-shadow: var(--shadow-elevated); padding: 1.75rem;
      width: 100%; max-width: 440px; position: relative;
    }
    .modal-title {
      font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700;
      font-size: 1.1rem; margin-bottom: 1rem;
    }
    .modal-close {
      position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px;
      border: none; background: transparent; border-radius: var(--radius-sm);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      color: var(--sanadome-text-soft); transition: all 0.15s;
    }
    .modal-close:hover { background: #f1f5f9; color: var(--sanadome-text); }
    .modal-close svg { width: 18px; height: 18px; }

    /* Photo dropzone */
    .photo-dropzone {
      border: 2px dashed var(--sanadome-border); border-radius: var(--radius);
      padding: 2rem; text-align: center; cursor: pointer;
      transition: all 0.2s ease; margin-bottom: 1rem;
    }
    .photo-dropzone:hover, .photo-dropzone.dragover {
      border-color: var(--sanadome-blue); background: var(--sanadome-blue-pale);
    }
    .photo-dropzone svg { width: 40px; height: 40px; color: var(--sanadome-blue-light); margin-bottom: 0.5rem; }
    .photo-dropzone p { font-size: 0.85rem; color: var(--sanadome-text-soft); }
    .photo-dropzone .browse-link {
      color: var(--sanadome-blue); font-weight: 600; cursor: pointer;
      text-decoration: underline;
    }
    .photo-preview {
      display: none; text-align: center; margin-bottom: 1rem;
    }
    .photo-preview img {
      width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .photo-preview p { font-size: 0.78rem; color: var(--sanadome-text-soft); margin-top: 0.5rem; }

    /* Toggle password visibility */
    .input-password-wrap {
      position: relative;
    }
    .input-password-wrap .form-input { padding-right: 2.5rem; width: 100%; }
    .toggle-password {
      position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; padding: 0.25rem;
      color: var(--sanadome-text-soft); transition: color 0.15s;
    }
    .toggle-password:hover { color: var(--sanadome-blue); }
    .toggle-password svg { width: 18px; height: 18px; }
  </style>
</head>
<body>
  <div class="app-loader"><div class="spinner"></div></div>
  <div class="app-layout">
    <aside class="app-sidebar">
      <a href="dashboard.html" class="sidebar-logo" aria-label="MijnSanadome">
        <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="40" height="40" rx="10" fill="url(#logo-grad)"/>
          <path d="M12 28V16l8 7 8-7v12h-3V19l-5 4.5-5-4.5v9H12z" fill="white"/>
          <defs>
            <linearGradient id="logo-grad" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
              <stop stop-color="#4a7c9c"/>
              <stop offset="1" stop-color="#6b9bb8"/>
            </linearGradient>
          </defs>
        </svg>
        <span class="sidebar-logo-text">Mijn<span>Sanadome</span></span>
      </a>
      <nav class="sidebar-nav">
        <div class="nav-label">Menu</div>
        <a href="dashboard.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Dashboard
        </a>
        <a href="#placeholder-rooster" class="nav-item" data-permission="nav.rooster">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Mijn rooster
        </a>
        <a href="#placeholder-verlof" class="nav-item" data-permission="nav.verlof">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Verlof
        </a>
        <a href="#placeholder-documenten" class="nav-item" data-permission="nav.documenten">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Documenten
        </a>
        <a href="#placeholder-berichten" class="nav-item" data-permission="nav.berichten">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Berichten
        </a>
        <div class="nav-label">Beheer</div>
        <a href="gebruikers.html" class="nav-item" data-permission="medewerkers.bekijken">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
          Medewerkers
        </a>
        <a href="nieuws.html" class="nav-item" data-permission="nieuws.bekijken">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><line x1="10" y1="6" x2="18" y2="6"/><line x1="10" y1="10" x2="18" y2="10"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
          Nieuwsbeheer
        </a>
        <a href="debiteuren.html" class="nav-item" data-permission="debiteuren.bekijken">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          Debiteuren
        </a>
        <a href="rechten.html" class="nav-item" data-permission="rechten.bekijken">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Rechten
        </a>
        <div class="nav-label">Account</div>
        <a href="profiel.html" class="nav-item active" data-permission="nav.gegevens">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Mijn Profiel
        </a>
        <a href="#placeholder-hr" class="nav-item" data-permission="nav.hr">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          HR &amp; handboek
        </a>
      </nav>
    </aside>

    <div class="app-main">
      <header class="topbar">
        <div class="topbar-title">Mijn Profiel</div>
        <div class="topbar-actions">
          <button type="button" class="topbar-icon-btn" aria-label="Meldingen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          </button>
          <a href="profiel.html" class="topbar-user" style="text-decoration:none;color:inherit;">
            <div class="topbar-avatar" id="user-avatar">—</div>
            <div class="topbar-user-info">
              <span class="topbar-user-name" id="user-name">Laden…</span>
              <span class="topbar-user-role" id="user-role-label">Medewerker</span>
            </div>
          </a>
          <button type="button" class="btn-logout" id="btn-logout">Uitloggen</button>
        </div>
      </header>

      <main class="profile-content">
        <div class="profile-inner">
        <!-- Profile header -->
        <div class="profile-header">
          <div class="profile-header-avatar">
            <div class="profile-header-avatar-img" id="profile-avatar-display">—</div>
            <button class="profile-photo-edit" id="btn-change-photo" title="Profielfoto wijzigen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            </button>
          </div>
          <div class="profile-header-info">
            <h1 id="profile-full-name">Laden…</h1>
            <p id="profile-email-display">—</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="profile-tabs">
          <button class="profile-tab active" data-tab="gegevens">Persoonlijke gegevens</button>
          <button class="profile-tab" data-tab="adres">Adres</button>
          <button class="profile-tab" data-tab="wachtwoord">Wachtwoord wijzigen</button>
        </div>

        <!-- Tab: Persoonlijke gegevens -->
        <div class="tab-panel active" id="tab-gegevens">
          <div class="profile-card">
            <div class="profile-card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              Persoonlijke informatie
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-voornaam">Voornaam</label>
                <input type="text" id="field-voornaam" class="form-input" placeholder="Voornaam">
              </div>
              <div class="form-group">
                <label class="form-label" for="field-achternaam">Achternaam</label>
                <input type="text" id="field-achternaam" class="form-input" placeholder="Achternaam">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-email">E-mailadres</label>
                <input type="email" id="field-email" class="form-input" disabled>
              </div>
              <div class="form-group">
                <label class="form-label" for="field-telefoon">Telefoonnummer</label>
                <input type="tel" id="field-telefoon" class="form-input" placeholder="+31 6 12345678">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-geboortedatum">Geboortedatum</label>
                <input type="date" id="field-geboortedatum" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label" for="field-geslacht">Geslacht</label>
                <select id="field-geslacht" class="form-input">
                  <option value="">— Selecteer —</option>
                  <option value="man">Man</option>
                  <option value="vrouw">Vrouw</option>
                  <option value="anders">Anders</option>
                  <option value="niet-zeggen">Zeg ik liever niet</option>
                </select>
              </div>
            </div>
            <div class="form-row single">
              <div class="form-group">
                <label class="form-label" for="field-bio">Over mij</label>
                <textarea id="field-bio" class="form-input" placeholder="Vertel iets over jezelf…" rows="3"></textarea>
              </div>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" id="btn-save-personal">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                Opslaan
              </button>
              <button class="btn btn-secondary" id="btn-cancel-personal">Annuleren</button>
            </div>
          </div>

          <div class="profile-card">
            <div class="profile-card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
              Werkgegevens
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-functie">Functie</label>
                <input type="text" id="field-functie" class="form-input" disabled placeholder="—">
              </div>
              <div class="form-group">
                <label class="form-label" for="field-afdeling">Afdeling</label>
                <input type="text" id="field-afdeling" class="form-input" disabled placeholder="—">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-startdatum">Startdatum</label>
                <input type="text" id="field-startdatum" class="form-input" disabled placeholder="—">
              </div>
              <div class="form-group">
                <label class="form-label" for="field-personeelsnr">Personeelsnummer</label>
                <input type="text" id="field-personeelsnr" class="form-input" disabled placeholder="—">
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Adres -->
        <div class="tab-panel" id="tab-adres">
          <div class="profile-card">
            <div class="profile-card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
              Woonadres
            </div>
            <div class="form-row single">
              <div class="form-group">
                <label class="form-label" for="field-straat">Straatnaam + huisnummer</label>
                <input type="text" id="field-straat" class="form-input" placeholder="Bijv. Kerkstraat 12a">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-postcode">Postcode</label>
                <input type="text" id="field-postcode" class="form-input" placeholder="1234 AB">
              </div>
              <div class="form-group">
                <label class="form-label" for="field-woonplaats">Woonplaats</label>
                <input type="text" id="field-woonplaats" class="form-input" placeholder="Nijmegen">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-provincie">Provincie</label>
                <select id="field-provincie" class="form-input">
                  <option value="">— Selecteer —</option>
                  <option value="drenthe">Drenthe</option>
                  <option value="flevoland">Flevoland</option>
                  <option value="friesland">Friesland</option>
                  <option value="gelderland">Gelderland</option>
                  <option value="groningen">Groningen</option>
                  <option value="limburg">Limburg</option>
                  <option value="noord-brabant">Noord-Brabant</option>
                  <option value="noord-holland">Noord-Holland</option>
                  <option value="overijssel">Overijssel</option>
                  <option value="utrecht">Utrecht</option>
                  <option value="zeeland">Zeeland</option>
                  <option value="zuid-holland">Zuid-Holland</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="field-land">Land</label>
                <input type="text" id="field-land" class="form-input" value="Nederland">
              </div>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" id="btn-save-address">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                Adres opslaan
              </button>
              <button class="btn btn-secondary" id="btn-cancel-address">Annuleren</button>
            </div>
          </div>

          <div class="profile-card">
            <div class="profile-card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              Noodcontact
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-nood-naam">Naam noodcontact</label>
                <input type="text" id="field-nood-naam" class="form-input" placeholder="Naam">
              </div>
              <div class="form-group">
                <label class="form-label" for="field-nood-relatie">Relatie</label>
                <select id="field-nood-relatie" class="form-input">
                  <option value="">— Selecteer —</option>
                  <option value="partner">Partner</option>
                  <option value="ouder">Ouder</option>
                  <option value="kind">Kind</option>
                  <option value="broer-zus">Broer/Zus</option>
                  <option value="vriend">Vriend(in)</option>
                  <option value="overig">Overig</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="field-nood-telefoon">Telefoonnummer</label>
                <input type="tel" id="field-nood-telefoon" class="form-input" placeholder="+31 6 12345678">
              </div>
              <div class="form-group">
                <label class="form-label" for="field-nood-email">E-mailadres</label>
                <input type="email" id="field-nood-email" class="form-input" placeholder="email@voorbeeld.nl">
              </div>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" id="btn-save-emergency">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                Noodcontact opslaan
              </button>
            </div>
          </div>
        </div>

        <!-- Tab: Wachtwoord -->
        <div class="tab-panel" id="tab-wachtwoord">
          <div class="profile-card">
            <div class="profile-card-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              Wachtwoord wijzigen
            </div>
            <p style="font-size:0.85rem;color:var(--sanadome-text-soft);margin-bottom:1.25rem;">
              Kies een sterk wachtwoord van minimaal 8 tekens met een combinatie van letters, cijfers en symbolen.
            </p>
            <div class="form-row single">
              <div class="form-group">
                <label class="form-label" for="field-new-password">Nieuw wachtwoord</label>
                <div class="input-password-wrap">
                  <input type="password" id="field-new-password" class="form-input" placeholder="Minimaal 8 tekens">
                  <button type="button" class="toggle-password" data-target="field-new-password" aria-label="Wachtwoord tonen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                  </button>
                </div>
                <div class="password-strength" id="pw-strength">
                  <div class="password-bar"><div class="password-bar-fill" id="pw-bar"></div></div>
                  <span class="password-strength-text" id="pw-text"></span>
                </div>
              </div>
            </div>
            <div class="form-row single">
              <div class="form-group">
                <label class="form-label" for="field-confirm-password">Bevestig nieuw wachtwoord</label>
                <div class="input-password-wrap">
                  <input type="password" id="field-confirm-password" class="form-input" placeholder="Herhaal wachtwoord">
                  <button type="button" class="toggle-password" data-target="field-confirm-password" aria-label="Wachtwoord tonen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" id="btn-save-password">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                Wachtwoord wijzigen
              </button>
            </div>
          </div>
        </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Photo upload modal -->
  <div class="modal-overlay" id="photo-modal">
    <div class="modal">
      <button class="modal-close" id="photo-modal-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <div class="modal-title">Profielfoto wijzigen</div>
      <div class="photo-dropzone" id="photo-dropzone">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <p>Sleep een foto hierheen of <span class="browse-link">klik om te bladeren</span></p>
        <p style="font-size:0.72rem;margin-top:0.35rem;color:#94a3b8;">JPG, PNG of WebP · Max 5 MB</p>
      </div>
      <div class="photo-preview" id="photo-preview">
        <img id="photo-preview-img" src="" alt="Preview">
        <p id="photo-preview-name"></p>
      </div>
      <input type="file" id="photo-file-input" accept="image/jpeg,image/png,image/webp" hidden>
      <div class="btn-group" style="justify-content:flex-end;">
        <button class="btn btn-secondary" id="btn-photo-cancel">Annuleren</button>
        <button class="btn btn-primary" id="btn-photo-save" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          Opslaan
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="nav-cache.js"></script>
  <script>
    (function() {
      // Instant render from cache if available
      var _cached = NavCache.load();
      if (_cached) NavCache.applyUI(_cached);

      var supabaseUrl = window.SUPABASE_URL;
      var supabaseKey = window.SUPABASE_ANON_KEY || window.SUPABASE_PUBLISHABLE_KEY;
      if (!supabaseUrl || !supabaseKey) { window.location.href = 'index.html'; return; }
      var sb = window.supabase.createClient(supabaseUrl, supabaseKey);
      var currentUser = null;
      var selectedPhotoFile = null;

      // ── Toast ──
      function showToast(msg, isError) {
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast' + (isError ? ' error' : '');
        setTimeout(function() { t.classList.add('show'); }, 10);
        setTimeout(function() { t.classList.remove('show'); }, 3500);
      }

      // ── Auth check ──
      sb.auth.getSession().then(function(res) {
        var session = res.data.session;
        if (!session || !session.user) { window.location.href = 'index.html'; return; }
        return sb.auth.getUser().then(function(ur) {
          if (!ur || ur.error || !ur.data || !ur.data.user) { window.location.href = 'index.html'; return; }
          currentUser = ur.data.user;
          initProfile(currentUser);
        });
      }).catch(function() { window.location.href = 'index.html'; });

      function initProfile(user) {
        var email = user.email || '—';
        var meta = user.user_metadata || {};
        var name = meta.full_name || meta.name || (email !== '—' ? email.split('@')[0] : 'Medewerker');
        var userRole = meta.role || 'Medewerker';

        // Header info
        document.getElementById('profile-full-name').textContent = name;
        document.getElementById('profile-email-display').textContent = email;
        document.getElementById('user-name').textContent = name;
        document.getElementById('user-role-label').textContent = userRole;

        // Initials
        var initials = name.split(/\s+/).map(function(s) { return (s[0] || '').toUpperCase(); }).slice(0, 2).join('') || '?';
        document.getElementById('user-avatar').textContent = initials;
        document.getElementById('profile-avatar-display').textContent = initials;

        // Fill form fields from metadata
        var parts = name.split(/\s+/);
        document.getElementById('field-voornaam').value = parts[0] || '';
        document.getElementById('field-achternaam').value = parts.slice(1).join(' ') || '';
        document.getElementById('field-email').value = email;
        document.getElementById('field-telefoon').value = meta.phone || '';
        document.getElementById('field-geboortedatum').value = meta.birth_date || '';
        document.getElementById('field-geslacht').value = meta.gender || '';
        document.getElementById('field-bio').value = meta.bio || '';
        document.getElementById('field-functie').value = meta.job_title || userRole;
        document.getElementById('field-afdeling').value = meta.department || '';
        document.getElementById('field-startdatum').value = meta.start_date || '';
        document.getElementById('field-personeelsnr').value = meta.employee_id || '';

        // Address
        document.getElementById('field-straat').value = meta.street || '';
        document.getElementById('field-postcode').value = meta.postal_code || '';
        document.getElementById('field-woonplaats').value = meta.city || '';
        document.getElementById('field-provincie').value = meta.province || '';
        document.getElementById('field-land').value = meta.country || 'Nederland';

        // Emergency contact
        document.getElementById('field-nood-naam').value = meta.emergency_name || '';
        document.getElementById('field-nood-relatie').value = meta.emergency_relation || '';
        document.getElementById('field-nood-telefoon').value = meta.emergency_phone || '';
        document.getElementById('field-nood-email').value = meta.emergency_email || '';

        // Profile photo
        if (meta.avatar_url) {
          var avatarEl = document.getElementById('profile-avatar-display');
          avatarEl.innerHTML = '<img src="' + meta.avatar_url + '" alt="Profielfoto">';
          // Also set topbar avatar
          var topbarAvatar = document.getElementById('user-avatar');
          topbarAvatar.innerHTML = '<img src="' + meta.avatar_url + '" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
        }

        // Permissions
        function getDefaultPerms(role) {
          var ALL = ['dashboard.nieuws','dashboard.berichten','dashboard.aanvragen','dashboard.contactgegevens','dashboard.dienstverband','dashboard.rooster','nav.rooster','nav.verlof','nav.documenten','nav.berichten','nav.gegevens','nav.hr','medewerkers.bekijken','medewerkers.aanmaken','medewerkers.bewerken','medewerkers.verwijderen','nieuws.bekijken','nieuws.aanmaken','nieuws.bewerken','nieuws.verwijderen','rechten.bekijken','rechten.bewerken','debiteuren.bekijken','debiteuren.beheren','debiteuren.importeren'];
          var p = {};
          ALL.forEach(function(k) {
            if (role === 'Manager') p[k] = true;
            else if (role === 'Assistent Manager') p[k] = k !== 'rechten.bewerken' && k !== 'medewerkers.verwijderen';
            else if (role === 'Senior Medewerker') p[k] = k.startsWith('dashboard.') || k.startsWith('nav.') || k === 'medewerkers.bekijken' || k === 'nieuws.bekijken' || k === 'debiteuren.bekijken';
            else p[k] = k.startsWith('dashboard.') || k.startsWith('nav.');
          });
          return p;
        }
        sb.from('role_permissions').select('permission, granted').eq('role', userRole).then(function(pr) {
          var perms = {};
          if (!pr.error && pr.data && pr.data.length > 0) {
            pr.data.forEach(function(r) { perms[r.permission] = r.granted; });
          } else {
            perms = getDefaultPerms(userRole);
          }
          return sb.from('user_permissions').select('permission, granted').eq('user_id', currentUser.id).then(function(upr) {
            if (!upr.error && upr.data && upr.data.length > 0) {
              upr.data.forEach(function(r) { perms[r.permission] = r.granted; });
            }
            return perms;
          }).catch(function() { return perms; });
        }).then(function(perms) {
          document.querySelectorAll('[data-permission]').forEach(function(el) {
            if (perms[el.getAttribute('data-permission')] === false) el.style.display = 'none';
          });
          document.body.classList.add('app-ready');
          var _m = currentUser.user_metadata || {};
          var _n = _m.full_name || _m.name || (currentUser.email || '').split('@')[0];
          var _ini = _n.split(/\s+/).map(function(s){return (s[0]||'').toUpperCase();}).slice(0,2).join('');
          NavCache.save({ userName: _n, initials: _ini, avatarUrl: _m.avatar_url, role: userRole, perms: perms });
        }).catch(function() {
          // Fail closed: apply default perms on error
          var fallbackPerms = getDefaultPerms(userRole);
          document.querySelectorAll('[data-permission]').forEach(function(el) {
            if (fallbackPerms[el.getAttribute('data-permission')] === false) el.style.display = 'none';
          });
          document.body.classList.add('app-ready');
        });
      }

      // ── Tabs ──
      document.querySelectorAll('.profile-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.profile-tab').forEach(function(t) { t.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
          tab.classList.add('active');
          document.getElementById('tab-' + tab.getAttribute('data-tab')).classList.add('active');
        });
      });

      // ── Save personal info ──
      document.getElementById('btn-save-personal').addEventListener('click', function() {
        var voornaam = document.getElementById('field-voornaam').value.trim();
        var achternaam = document.getElementById('field-achternaam').value.trim();
        var fullName = (voornaam + ' ' + achternaam).trim();
        if (!fullName) { showToast('Vul minimaal een naam in.', true); return; }

        sb.auth.updateUser({
          data: {
            full_name: fullName,
            name: fullName,
            phone: document.getElementById('field-telefoon').value.trim(),
            birth_date: document.getElementById('field-geboortedatum').value,
            gender: document.getElementById('field-geslacht').value,
            bio: document.getElementById('field-bio').value.trim()
          }
        }).then(function(res) {
          if (res.error) { showToast('Fout: ' + res.error.message, true); return; }
          showToast('Persoonlijke gegevens opgeslagen!');
          document.getElementById('profile-full-name').textContent = fullName;
          document.getElementById('user-name').textContent = fullName;
          var initials = fullName.split(/\s+/).map(function(s) { return (s[0] || '').toUpperCase(); }).slice(0, 2).join('');
          document.getElementById('user-avatar').textContent = initials;
          document.getElementById('profile-avatar-display').textContent = initials;
        }).catch(function(e) { showToast('Fout bij opslaan: ' + e.message, true); });
      });

      // ── Save address ──
      document.getElementById('btn-save-address').addEventListener('click', function() {
        sb.auth.updateUser({
          data: {
            street: document.getElementById('field-straat').value.trim(),
            postal_code: document.getElementById('field-postcode').value.trim(),
            city: document.getElementById('field-woonplaats').value.trim(),
            province: document.getElementById('field-provincie').value,
            country: document.getElementById('field-land').value.trim()
          }
        }).then(function(res) {
          if (res.error) { showToast('Fout: ' + res.error.message, true); return; }
          showToast('Adres opgeslagen!');
        }).catch(function(e) { showToast('Fout bij opslaan: ' + e.message, true); });
      });

      // ── Save emergency contact ──
      document.getElementById('btn-save-emergency').addEventListener('click', function() {
        sb.auth.updateUser({
          data: {
            emergency_name: document.getElementById('field-nood-naam').value.trim(),
            emergency_relation: document.getElementById('field-nood-relatie').value,
            emergency_phone: document.getElementById('field-nood-telefoon').value.trim(),
            emergency_email: document.getElementById('field-nood-email').value.trim()
          }
        }).then(function(res) {
          if (res.error) { showToast('Fout: ' + res.error.message, true); return; }
          showToast('Noodcontact opgeslagen!');
        }).catch(function(e) { showToast('Fout bij opslaan: ' + e.message, true); });
      });

      // ── Password ──
      var pwInput = document.getElementById('field-new-password');
      var pwBar = document.getElementById('pw-bar');
      var pwText = document.getElementById('pw-text');
      pwInput.addEventListener('input', function() {
        var v = pwInput.value;
        var score = 0;
        if (v.length >= 8) score++;
        if (v.length >= 12) score++;
        if (/[a-z]/.test(v) && /[A-Z]/.test(v)) score++;
        if (/\d/.test(v)) score++;
        if (/[^a-zA-Z0-9]/.test(v)) score++;
        var pct = Math.min(score * 20, 100);
        var colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#16a34a'];
        var labels = ['Zeer zwak', 'Zwak', 'Redelijk', 'Sterk', 'Zeer sterk'];
        pwBar.style.width = pct + '%';
        pwBar.style.background = colors[Math.min(score, 4)];
        pwText.textContent = v.length ? labels[Math.min(score, 4)] : '';
      });

      document.getElementById('btn-save-password').addEventListener('click', function() {
        var pw = document.getElementById('field-new-password').value;
        var confirm = document.getElementById('field-confirm-password').value;
        if (pw.length < 8) { showToast('Wachtwoord moet minimaal 8 tekens zijn.', true); return; }
        if (pw !== confirm) { showToast('Wachtwoorden komen niet overeen.', true); return; }

        sb.auth.updateUser({ password: pw }).then(function(res) {
          if (res.error) { showToast('Fout: ' + res.error.message, true); return; }
          showToast('Wachtwoord succesvol gewijzigd!');
          document.getElementById('field-new-password').value = '';
          document.getElementById('field-confirm-password').value = '';
          pwBar.style.width = '0';
          pwText.textContent = '';
        }).catch(function(e) { showToast('Fout bij wijzigen: ' + e.message, true); });
      });

      // ── Toggle password visibility ──
      document.querySelectorAll('.toggle-password').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var target = document.getElementById(btn.getAttribute('data-target'));
          if (target.type === 'password') {
            target.type = 'text';
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
          } else {
            target.type = 'password';
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>';
          }
        });
      });

      // ── Photo modal ──
      var photoModal = document.getElementById('photo-modal');
      var photoDropzone = document.getElementById('photo-dropzone');
      var photoFileInput = document.getElementById('photo-file-input');
      var photoPreview = document.getElementById('photo-preview');
      var photoPreviewImg = document.getElementById('photo-preview-img');
      var photoPreviewName = document.getElementById('photo-preview-name');
      var btnPhotoSave = document.getElementById('btn-photo-save');

      document.getElementById('btn-change-photo').addEventListener('click', function() {
        photoModal.classList.add('show');
        resetPhotoModal();
      });
      document.getElementById('photo-modal-close').addEventListener('click', function() { photoModal.classList.remove('show'); });
      document.getElementById('btn-photo-cancel').addEventListener('click', function() { photoModal.classList.remove('show'); });
      photoModal.addEventListener('click', function(e) { if (e.target === photoModal) photoModal.classList.remove('show'); });

      function resetPhotoModal() {
        selectedPhotoFile = null;
        photoDropzone.style.display = '';
        photoPreview.style.display = 'none';
        btnPhotoSave.disabled = true;
        photoFileInput.value = '';
      }

      photoDropzone.addEventListener('click', function() { photoFileInput.click(); });
      photoDropzone.addEventListener('dragover', function(e) { e.preventDefault(); photoDropzone.classList.add('dragover'); });
      photoDropzone.addEventListener('dragleave', function() { photoDropzone.classList.remove('dragover'); });
      photoDropzone.addEventListener('drop', function(e) {
        e.preventDefault(); photoDropzone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handlePhotoFile(e.dataTransfer.files[0]);
      });
      photoFileInput.addEventListener('change', function() {
        if (photoFileInput.files.length) handlePhotoFile(photoFileInput.files[0]);
      });

      function handlePhotoFile(file) {
        if (file.size > 5 * 1024 * 1024) { showToast('Bestand is te groot (max 5 MB).', true); return; }
        if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) { showToast('Ongeldig bestandstype.', true); return; }
        selectedPhotoFile = file;
        var reader = new FileReader();
        reader.onload = function(e) {
          photoPreviewImg.src = e.target.result;
          photoDropzone.style.display = 'none';
          photoPreview.style.display = 'block';
          photoPreviewName.textContent = file.name + ' (' + (file.size / 1024).toFixed(0) + ' KB)';
          btnPhotoSave.disabled = false;
        };
        reader.readAsDataURL(file);
      }

      btnPhotoSave.addEventListener('click', function() {
        if (!selectedPhotoFile || !currentUser) return;
        btnPhotoSave.disabled = true;
        btnPhotoSave.textContent = 'Uploaden…';

        var ext = selectedPhotoFile.name.split('.').pop().toLowerCase();
        var filePath = currentUser.id + '.' + ext;
        var meta = currentUser.user_metadata || {};
        var oldAvatarUrl = meta.avatar_url || '';

        // Delete old avatar files first (try all common extensions)
        var deletePromise;
        if (oldAvatarUrl) {
          var oldPath = oldAvatarUrl.split('/avatars/').pop();
          if (oldPath && oldPath !== filePath) {
            deletePromise = sb.storage.from('avatars').remove([oldPath]);
          } else if (oldPath === filePath) {
            // Same path, upsert will overwrite
            deletePromise = Promise.resolve();
          } else {
            deletePromise = Promise.resolve();
          }
        } else {
          // Try to remove any existing avatar with common extensions
          var possiblePaths = ['jpg','jpeg','png','webp'].map(function(e) { return currentUser.id + '.' + e; });
          deletePromise = sb.storage.from('avatars').remove(possiblePaths);
        }

        deletePromise.then(function() {
          return sb.storage.from('avatars').upload(filePath, selectedPhotoFile, { upsert: true });
        }).then(function(upRes) {
          if (upRes.error) { showToast('Upload mislukt: ' + upRes.error.message, true); resetPhotoModal(); return; }
          var publicUrl = sb.storage.from('avatars').getPublicUrl(filePath).data.publicUrl;
          // Add cache-buster to force refresh
          publicUrl = publicUrl + '?t=' + Date.now();
          return sb.auth.updateUser({ data: { avatar_url: publicUrl } }).then(function() {
            // Update profile header avatar
            var avatarEl = document.getElementById('profile-avatar-display');
            avatarEl.innerHTML = '<img src="' + publicUrl + '" alt="Profielfoto">';
            // Update topbar avatar
            var topbarAvatar = document.getElementById('user-avatar');
            topbarAvatar.innerHTML = '<img src="' + publicUrl + '" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
            showToast('Profielfoto bijgewerkt!');
            photoModal.classList.remove('show');
          });
        }).catch(function(e) {
          showToast('Fout bij uploaden: ' + e.message, true);
        }).finally(function() {
          btnPhotoSave.disabled = false;
          btnPhotoSave.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Opslaan';
        });
      });

      // ── Cancel buttons ──
      document.getElementById('btn-cancel-personal').addEventListener('click', function() {
        if (currentUser) initProfile(currentUser);
      });
      document.getElementById('btn-cancel-address').addEventListener('click', function() {
        if (currentUser) initProfile(currentUser);
      });

      // ── Logout ──
      document.getElementById('btn-logout').addEventListener('click', function(e) {
        e.preventDefault();
        NavCache.clear();
        sb.auth.signOut().then(function() { window.location.href = 'index.html'; });
      });
    })();
  </script>
</body>
</html>
